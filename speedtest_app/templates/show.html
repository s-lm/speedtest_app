<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Speedtest App</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/speedtest.css') }}">
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart.umd.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chartjs-adapter-date-fns.bundle.min.js') }}"></script>
</head>
<body>
    {% from "_toolbar.html" import toolbar %}
    {{ toolbar(session.user if session.get('user') else None, ENABLE_OIDC) }}
    <h2>ðŸ“Š Internet Speed Test History</h2>

    <div class="month-selector">
        <label for="monthSelect">Select Month:</label>
        <select id="monthSelect"></select>
    </div>

    <div id="pagination-controls" style="margin-bottom:1rem;">
        <button id="prevPage" disabled title="Previous Page">â—€</button>
        <span id="pageInfo"></span>
        <button id="nextPage" disabled title="Next Page">â–¶</button>
    </div>


    <canvas id="speedChart" width="800" height="400"></canvas>

    <script>
        // Data and pagination
        let allPoints = [];
        let months = [];
        let currentPage = 1;
        let perPage = 500;
        let totalPages = 1;

        // Chart initialization (ONCE, at startup)
        const ctx = document.getElementById('speedChart').getContext('2d');
        const isDark = document.body.classList.contains('dark');
        window.speedChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Download Speed (Mbit/s)', data: [], borderColor: 'blue', fill: false, yAxisID: 'A' },
                    { label: 'Upload Speed (Mbit/s)', data: [], borderColor: 'red', fill: false, yAxisID: 'A' },
                    { label: 'Ping (ms)', data: [], borderColor: 'green', fill: false, yAxisID: 'B' }
                ]
            },
            options: createChartOptions(isDark)
        });

        function getMonthKey(dateStr) {
            const date = new Date(dateStr);
            return date.toISOString().slice(0, 7);  // "YYYY-MM"
        }

        function updateChart(points) {
            if (!window.speedChart) {
                console.error("Chart not initialized yet.");
                return;
            }

            const downloadData = points.map(p => ({ x: p.timestamp, y: p.download / 1_000_000, meta: p }));
            const uploadData = points.map(p => ({ x: p.timestamp, y: p.upload / 1_000_000, meta: p }));
            const pingData = points.map(p => ({ x: p.timestamp, y: p.ping, meta: p }));

            window.speedChart.data.datasets[0].data = downloadData;
            window.speedChart.data.datasets[1].data = uploadData;
            window.speedChart.data.datasets[2].data = pingData;
            window.speedChart.update();
        }

        function createChartOptions(dark) {
            return {
                interaction: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day' },
                        ticks: {
                            color: dark ? '#ccc' : '#111'
                        },
                        grid: {
                            color: dark ? '#444' : '#ccc'
                        }
                    },
                    A: {
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Speed (Mbit/s)',
                            color: dark ? '#ccc' : '#111'
                        },
                        ticks: { color: dark ? '#ccc' : '#111' },
                        grid: {
                            color: dark ? '#444' : '#ccc'
                        }
                    },
                    B: {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Ping (ms)',
                            color: dark ? '#ccc' : '#111'
                        },
                        ticks: { color: dark ? '#ccc' : '#111' },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: dark ? '#ccc' : '#111'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const p = context.raw.meta;
                                if (!p) return '';
                                if (context.dataset.label === 'Ping (ms)') {
                                    return [
                                        `Ping: ${p.ping} ms`,
                                        `Sponsor: ${p.sponsor}`,
                                        `Server: ${p.server}`,
                                        `Distance: ${p.distance} km`,
                                        `IP: ${p.ip}`,
                                        `ISP: ${p.isp}`
                                    ];
                                } else if (context.dataset.label === 'Download Speed (Mbit/s)') {
                                    return [
                                        `Download: ${(p.download/1_000_000).toFixed(2)} Mbit/s`,
                                        `Sponsor: ${p.sponsor}`,
                                        `Server: ${p.server}`,
                                        `Distance: ${p.distance} km`,
                                        `IP: ${p.ip}`,
                                        `ISP: ${p.isp}`
                                    ];
                                } else if (context.dataset.label === 'Upload Speed (Mbit/s)') {
                                    return [
                                        `Upload: ${(p.upload/1_000_000).toFixed(2)} Mbit/s`,
                                        `Sponsor: ${p.sponsor}`,
                                        `Server: ${p.server}`,
                                        `Distance: ${p.distance} km`,
                                        `IP: ${p.ip}`,
                                        `ISP: ${p.isp}`
                                    ];
                                }
                                return '';
                            }
                        }
                    }
                }
            };
        }

        function applyChartTheme(dark) {
            const chart = window.speedChart;
            chart.options = createChartOptions(dark);
            chart.update();
        }

        function fetchAndRender(page = 1) {
            fetch(`/api/data?page=${page}&per_page=${perPage}`)
                .then(response => response.json())
                .then(result => {
                    allPoints = result.data.map(row => ({
                        timestamp: row.timestamp,
                        ping: parseFloat(row.ping),
                        download: parseFloat(row.download),
                        upload: parseFloat(row.upload),
                        sponsor: row.sponsor,
                        server: row.server,
                        distance: row.distance,
                        ip: row.ip,
                        isp: row.isp,
                        month: getMonthKey(row.timestamp)
                    }));

                    months = [...new Set(allPoints.map(p => p.month))].sort().reverse();
                    const select = document.getElementById('monthSelect');
                    select.innerHTML = '';
                    months.forEach(month => {
                        const option = document.createElement('option');
                        option.value = month;
                        option.textContent = month;
                        select.appendChild(option);
                    });

                    // Only update chart if there is at least one month of data and chart is initialized
                    if (months.length > 0 && window.speedChart) {
                        select.value = months[0];
                        updateChart(allPoints.filter(p => p.month === months[0]));
                    }

                    select.onchange = (e) => {
                        const month = e.target.value;
                        updateChart(allPoints.filter(p => p.month === month));
                    };

                    // Pagination controls
                    currentPage = result.page;
                    totalPages = result.pages;
                    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
                    document.getElementById('prevPage').disabled = !result.has_prev;
                    document.getElementById('nextPage').disabled = !result.has_next;
                });
        }

        document.getElementById('prevPage').onclick = () => {
            if (currentPage > 1) fetchAndRender(currentPage - 1);
        };

        document.getElementById('nextPage').onclick = () => {
            if (currentPage < totalPages) fetchAndRender(currentPage + 1);
        };

        // Initial load
        fetchAndRender();
    </script>
</body>
</html>